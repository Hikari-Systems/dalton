# ==========================================
# security.conf - Fixed for ModSecurity v3
# ==========================================

# ModSecurity v3 Configuration
<IfModule security3_module>
    # Enable ModSecurity
    modsecurity on
    
    # Load the main ModSecurity configuration
    modsecurity_rules_file /etc/modsecurity/modsecurity.conf
    
    # Load OWASP Core Rule Set
    modsecurity_rules_file /usr/local/coreruleset/crs-setup.conf
    modsecurity_rules_file /usr/local/coreruleset/rules/REQUEST-901-INITIALIZATION.conf
    modsecurity_rules_file /usr/local/coreruleset/rules/REQUEST-905-COMMON-EXCEPTIONS.conf
    modsecurity_rules_file /usr/local/coreruleset/rules/REQUEST-911-METHOD-ENFORCEMENT.conf
    modsecurity_rules_file /usr/local/coreruleset/rules/REQUEST-913-SCANNER-DETECTION.conf
    modsecurity_rules_file /usr/local/coreruleset/rules/REQUEST-920-PROTOCOL-ENFORCEMENT.conf
    modsecurity_rules_file /usr/local/coreruleset/rules/REQUEST-921-PROTOCOL-ATTACK.conf
    modsecurity_rules_file /usr/local/coreruleset/rules/REQUEST-922-MULTIPART-ATTACK.conf
    modsecurity_rules_file /usr/local/coreruleset/rules/REQUEST-930-APPLICATION-ATTACK-LFI.conf
    modsecurity_rules_file /usr/local/coreruleset/rules/REQUEST-931-APPLICATION-ATTACK-RFI.conf
    modsecurity_rules_file /usr/local/coreruleset/rules/REQUEST-932-APPLICATION-ATTACK-RCE.conf
    modsecurity_rules_file /usr/local/coreruleset/rules/REQUEST-933-APPLICATION-ATTACK-PHP.conf
    modsecurity_rules_file /usr/local/coreruleset/rules/REQUEST-934-APPLICATION-ATTACK-GENERIC.conf
    modsecurity_rules_file /usr/local/coreruleset/rules/REQUEST-941-APPLICATION-ATTACK-XSS.conf
    modsecurity_rules_file /usr/local/coreruleset/rules/REQUEST-942-APPLICATION-ATTACK-SQLI.conf
    modsecurity_rules_file /usr/local/coreruleset/rules/REQUEST-943-APPLICATION-ATTACK-SESSION-FIXATION.conf
    modsecurity_rules_file /usr/local/coreruleset/rules/REQUEST-944-APPLICATION-ATTACK-JAVA.conf
    modsecurity_rules_file /usr/local/coreruleset/rules/REQUEST-949-BLOCKING-EVALUATION.conf
    modsecurity_rules_file /usr/local/coreruleset/rules/RESPONSE-950-DATA-LEAKAGES.conf
    modsecurity_rules_file /usr/local/coreruleset/rules/RESPONSE-951-DATA-LEAKAGES-SQL.conf
    modsecurity_rules_file /usr/local/coreruleset/rules/RESPONSE-952-DATA-LEAKAGES-JAVA.conf
    modsecurity_rules_file /usr/local/coreruleset/rules/RESPONSE-953-DATA-LEAKAGES-PHP.conf
    modsecurity_rules_file /usr/local/coreruleset/rules/RESPONSE-954-DATA-LEAKAGES-IIS.conf
    modsecurity_rules_file /usr/local/coreruleset/rules/RESPONSE-955-WEB-SHELLS.conf
    modsecurity_rules_file /usr/local/coreruleset/rules/RESPONSE-959-BLOCKING-EVALUATION.conf
    modsecurity_rules_file /usr/local/coreruleset/rules/RESPONSE-980-CORRELATION.conf
</IfModule>

# mod_evasive Configuration - Optimized for high concurrency
# <IfModule mod_evasive24.c>
#     # Increased hash table size for better performance under load
#     DOSHashTableSize    8192
    
#     # More lenient thresholds for high-traffic scenarios
#     # Increased from 5 to 10 for high-traffic scenarios
#     DOSPageCount        20
#     DOSPageInterval     1
#     # Increased from 50 to 100 for high-traffic scenarios
#     DOSSiteCount        100
#     DOSSiteInterval     1
    
#     # Shorter blocking period to prevent long-term blocking of legitimate users
#     # Reduced from 600 to 300 seconds
#     DOSBlockingPeriod   300
    
#     # Disable email notifications in containerized environment
#     # DOSEmailNotify      privacy@hikari-systems.com
    
#     # Disable system command execution in containerized environment
#     # DOSSystemCommand    "iptables -A INPUT -s %s -j DROP"
    
#     # Whitelist common internal IPs
#     DOSWhitelist        127.0.0.1
#     DOSWhitelist        10.0.0.0/8
#     DOSWhitelist        172.16.0.0/12
#     DOSWhitelist        192.168.0.0/16
    
#     # Log DOS events to Apache error log instead of separate file
#     DOSLogDir           /proc/self/fd/2
# </IfModule>

# Security Headers (unchanged)
<IfModule mod_headers.c>
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
    Header always set Content-Security-Policy "default-src 'self'; frame-ancestors 'none'"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
    
    Header always unset Server
    Header always unset X-Powered-By
</IfModule>

# Hide Apache version information
ServerTokens Prod
ServerSignature Off

# Disable unnecessary HTTP methods
<Location "/">
    <LimitExcept GET POST HEAD>
        Require all denied
    </LimitExcept>
</Location>

# Disable server-status and server-info
<Location "/server-status">
    Require all denied
</Location>

<Location "/server-info">
    Require all denied
</Location>

# Prevent access to .htaccess and other sensitive files
<FilesMatch "^\.">
    Require all denied
</FilesMatch>

# Prevent access to backup and temporary files
<FilesMatch "\.(bak|backup|swp|tmp)$">
    Require all denied
</FilesMatch>