# ==========================================
# security.conf
# Apache Security Configuration
# ==========================================

# Load headers module for security headers
LoadModule headers_module modules/mod_headers.so

# ModSecurity Configuration
<IfModule mod_security3.c>
    SecRuleEngine On
    Include /etc/modsecurity/modsecurity.conf
    Include /usr/local/coreruleset/crs-setup.conf
    Include /usr/local/coreruleset/rules/*.conf
    
    # Custom security rules can be added here
    # SecRule ARGS "@detectSQLi" "id:1001,phase:2,block,msg:'SQL Injection Attack'"
</IfModule>

# mod_evasive Configuration
<IfModule mod_evasive24.c>
    DOSHashTableSize    2048
    DOSPageCount        5
    DOSPageInterval     1
    DOSSiteCount        50
    DOSSiteInterval     1
    DOSBlockingPeriod   600
    DOSEmailNotify      admin@example.com
    DOSSystemCommand    "iptables -A INPUT -s %s -j DROP"
    DOSLogDir           "/var/log/mod_evasive"
    DOSWhitelist        127.0.0.1
    # Add your trusted IPs here
    # DOSWhitelist        192.168.1.0/24
</IfModule>

# Security Headers
<IfModule mod_headers.c>
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
    Header always set Content-Security-Policy "default-src 'self'; frame-ancestors 'none'"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
    
    # Remove server signature
    Header always unset Server
    Header always unset X-Powered-By
</IfModule>

# Hide Apache version information
ServerTokens Prod
ServerSignature Off

# Disable unnecessary HTTP methods
<Location "/">
    <LimitExcept GET POST HEAD>
        Require all denied
    </LimitExcept>
</Location>

# Disable server-status and server-info
<Location "/server-status">
    Require all denied
</Location>

<Location "/server-info">
    Require all denied
</Location>

# Prevent access to .htaccess and other sensitive files
<FilesMatch "^\.">
    Require all denied
</FilesMatch>

# Prevent access to backup and temporary files
<FilesMatch "\.(bak|backup|swp|tmp)$">
    Require all denied
</FilesMatch>