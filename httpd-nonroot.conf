# httpd-nonroot.conf
# Apache configuration for running behind AWS ALB

# Set server name to suppress FQDN warning
ServerName localhost

# Listen on port 3000 for ALB traffic
Listen 3000

# Set user and group (though this won't take effect when already running as www-data)
User www-data
Group www-data

# Update PID file location to writable directory
PidFile /usr/local/apache2/run/httpd.pid

# Update log file locations with extended format for debugging
LogFormat "%h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\" \"%{X-Forwarded-For}i\" \"%{X-Forwarded-Proto}i\"" combined_with_forwarded
ErrorLog /proc/self/fd/2
CustomLog /proc/self/fd/1 combined_with_forwarded

# Load required modules for ALB integration and security
LoadModule remoteip_module modules/mod_remoteip.so
LoadModule rewrite_module modules/mod_rewrite.so
LoadModule info_module modules/mod_info.so
LoadModule logio_module modules/mod_logio.so
# LoadModule evasive_module modules/mod_evasive24.so
LoadModule security3_module modules/mod_security3.so

# ==========================================
# HIGH CONCURRENCY MPM CONFIGURATION
# ==========================================

# Use event MPM for better performance with keep-alive connections
<IfModule mpm_event_module>
    # Maximum number of worker processes (adjust based on CPU cores)
    # For high CPU/memory workloads, start with 2x CPU cores
    ServerLimit 16
    StartServers 4
    MinSpareThreads 25
    MaxSpareThreads 75
    
    # Threads per process (adjust based on available memory)
    # Each thread uses ~8MB of memory, so calculate based on available RAM
    ThreadsPerChild 25
    MaxRequestWorkers 400
    
    # Maximum connections per child process before recycling
    # Helps prevent memory leaks in long-running processes
    MaxConnectionsPerChild 10000
    
    # Thread limits for better resource management
    ThreadLimit 64
    
    # Async request processing for better concurrency
    AsyncRequestWorkerFactor 2
</IfModule>

# Fallback to worker MPM if event is not available
<IfModule mpm_worker_module>
    ServerLimit 16
    StartServers 4
    MinSpareThreads 25
    MaxSpareThreads 75
    ThreadsPerChild 25
    MaxRequestWorkers 400
    MaxConnectionsPerChild 10000
    ThreadLimit 64
</IfModule>

# ==========================================
# CONNECTION AND TIMEOUT OPTIMIZATION
# ==========================================

# KeepAlive settings for better connection reuse
KeepAlive On
KeepAliveTimeout 5
MaxKeepAliveRequests 1000

# Timeout settings optimized for high concurrency
Timeout 30
KeepAliveTimeout 5
HostnameLookups Off

# Request processing limits
LimitRequestBody 10485760
LimitRequestFields 100
LimitRequestFieldSize 8190
LimitRequestLine 8190

# Configure mod_remoteip for AWS ALB and CloudFront
<IfModule mod_remoteip.c>
    # Trust private IP ranges (ALB)
    RemoteIPTrustedProxy 10.0.0.0/8
    RemoteIPTrustedProxy 172.16.0.0/12
    RemoteIPTrustedProxy 192.168.0.0/16
    
    # Trust CloudFront IP ranges (consolidated from AWS IP ranges JSON as of 2025-09-23)
    RemoteIPTrustedProxy 13.32.0.0/15
    RemoteIPTrustedProxy 13.224.0.0/14
    RemoteIPTrustedProxy 13.249.0.0/16
    RemoteIPTrustedProxy 15.158.0.0/16
    RemoteIPTrustedProxy 18.154.0.0/15
    RemoteIPTrustedProxy 18.160.0.0/15
    RemoteIPTrustedProxy 18.164.0.0/15
    RemoteIPTrustedProxy 18.172.0.0/15
    RemoteIPTrustedProxy 18.238.0.0/15
    RemoteIPTrustedProxy 18.244.0.0/15
    RemoteIPTrustedProxy 23.91.0.0/19
    RemoteIPTrustedProxy 52.46.0.0/18
    RemoteIPTrustedProxy 52.222.128.0/17
    RemoteIPTrustedProxy 54.192.0.0/16
    RemoteIPTrustedProxy 54.230.200.0/21
    RemoteIPTrustedProxy 54.230.208.0/20
    RemoteIPTrustedProxy 54.230.224.0/19
    RemoteIPTrustedProxy 54.240.128.0/18
    RemoteIPTrustedProxy 58.254.138.0/25
    RemoteIPTrustedProxy 64.252.128.0/18
    RemoteIPTrustedProxy 65.9.128.0/18
    RemoteIPTrustedProxy 70.132.0.0/18
    RemoteIPTrustedProxy 71.152.0.0/17
    RemoteIPTrustedProxy 99.86.0.0/16
    RemoteIPTrustedProxy 108.156.0.0/14
    RemoteIPTrustedProxy 111.13.171.128/26
    RemoteIPTrustedProxy 111.13.171.192/26
    RemoteIPTrustedProxy 111.13.185.32/27
    RemoteIPTrustedProxy 116.129.226.0/25
    RemoteIPTrustedProxy 116.129.226.128/26
    RemoteIPTrustedProxy 118.193.97.64/26
    RemoteIPTrustedProxy 120.52.22.96/27
    RemoteIPTrustedProxy 120.52.39.128/27
    RemoteIPTrustedProxy 120.253.240.192/26
    RemoteIPTrustedProxy 120.253.245.128/26
    RemoteIPTrustedProxy 130.176.0.0/17
    RemoteIPTrustedProxy 130.176.128.0/18
    RemoteIPTrustedProxy 180.163.57.0/25
    RemoteIPTrustedProxy 180.163.57.128/26
    RemoteIPTrustedProxy 204.246.168.0/22
    RemoteIPTrustedProxy 204.246.172.0/24
    RemoteIPTrustedProxy 204.246.173.0/24
    RemoteIPTrustedProxy 205.251.202.0/23
    RemoteIPTrustedProxy 205.251.206.0/23
    RemoteIPTrustedProxy 205.251.208.0/20
    RemoteIPTrustedProxy 205.251.249.0/24
    RemoteIPTrustedProxy 205.251.250.0/23
    RemoteIPTrustedProxy 205.251.252.0/23
    RemoteIPTrustedProxy 205.251.254.0/24
    RemoteIPTrustedProxy 216.137.32.0/19
    RemoteIPTrustedProxy 3.160.0.0/14
    RemoteIPTrustedProxy 3.164.64.0/18
    RemoteIPTrustedProxy 3.165.0.0/16
    RemoteIPTrustedProxy 3.166.0.0/15
    RemoteIPTrustedProxy 3.168.0.0/14
    RemoteIPTrustedProxy 3.173.0.0/17
    RemoteIPTrustedProxy 3.173.192.0/18
    RemoteIPTrustedProxy 3.174.0.0/15
    
    # AWS ALB uses X-Forwarded-For for client IP
    RemoteIPHeader X-Forwarded-For
    
    # Log the original IP
    RemoteIPTrustedProxyList /dev/null
</IfModule>

# Update document root permissions
<Directory "/usr/local/apache2/htdocs">
    Options -Indexes +FollowSymLinks
    AllowOverride None
    Require all granted
</Directory>

# Handle X-Forwarded-Proto for HTTPS detection
# This ensures ModSecurity and your application can detect HTTPS properly
<IfModule mod_setenvif.c>
    SetEnvIf X-Forwarded-Proto "https" HTTPS=on
    SetEnvIf X-Forwarded-Proto "https" SERVER_PORT=443
    SetEnvIf X-Forwarded-Proto "http" SERVER_PORT=80
</IfModule>

# Security headers with ALB considerations
<IfModule mod_headers.c>
    # Only set HSTS if traffic came via HTTPS (X-Forwarded-Proto: https)
    Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" env=HTTPS
    
    # Other security headers
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Content-Security-Policy "default-src 'self'; frame-ancestors 'none'"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
    
    # Remove server signature and version info
    Header always unset Server
    Header always unset X-Powered-By
    
    # Preserve ALB headers for downstream applications if needed
    # Header always set X-Forwarded-For "%{REMOTE_ADDR}s"
</IfModule>

# Ensure mod_evasive considers real client IP (logs disabled for Docker stdout/stderr)
<IfModule mod_evasive24.c>
    # Note: mod_evasive will use the remoteip-processed IP thanks to mod_remoteip
    # DOSLogDir is commented out to prevent file logging - events go to Apache error log instead
</IfModule>

Include conf/security.conf

# Include per-site configurations (if any exist)
IncludeOptional conf/sites-enabled/*.conf

# # Container health check endpoint
# <Location "/healthcheck">
#     <RequireAll>
#         Require all granted
#     </RequireAll>
#     # Simple health check response
#     <IfModule mod_rewrite.c>
#         RewriteEngine On
#         RewriteRule .* - [R=200,L]
#     </IfModule>
# </Location>

# # Optional: Debugging location to see headers (remove in production)
# <Location "/debug-headers">
#     SetHandler server-info
#     Require ip 10.0.0.0/8
#     Require ip 172.16.0.0/12
#     Require ip 192.168.0.0/16
#     <IfModule mod_info.c>
#         SetHandler server-info
#     </IfModule>
# </Location>
