# httpd-nonroot.conf
# Apache configuration for running behind AWS ALB

# Listen on port 3000 for ALB traffic
Listen 3000

# Set user and group (though this won't take effect when already running as www-data)
User www-data
Group www-data

# Update PID file location to writable directory
PidFile /usr/local/apache2/run/httpd.pid

# Update log file locations with extended format for debugging
LogFormat "%h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\" \"%{X-Forwarded-For}i\" \"%{X-Forwarded-Proto}i\"" combined_with_forwarded
ErrorLog /usr/local/apache2/logs/error.log
CustomLog /usr/local/apache2/logs/access.log combined_with_forwarded

# Load mod_remoteip for ALB integration
LoadModule remoteip_module modules/mod_remoteip.so

# Configure mod_remoteip for AWS ALB
# AWS ALB IP ranges - you may need to update these based on your region
# These are common ALB CIDR ranges, but check AWS documentation for your specific region
<IfModule mod_remoteip.c>
    # Trust ALB IP ranges (these are examples - update for your AWS region)
    RemoteIPTrustedProxy 10.0.0.0/8
    RemoteIPTrustedProxy 172.16.0.0/12
    RemoteIPTrustedProxy 192.168.0.0/16
    
    # AWS ALB uses X-Forwarded-For for client IP
    RemoteIPHeader X-Forwarded-For
    
    # Log the original IP
    RemoteIPTrustedProxyList /dev/null
</IfModule>

# Update document root permissions
<Directory "/usr/local/apache2/htdocs">
    Options -Indexes +FollowSymLinks
    AllowOverride None
    Require all granted
</Directory>

# Handle X-Forwarded-Proto for HTTPS detection
# This ensures ModSecurity and your application can detect HTTPS properly
<IfModule mod_setenvif.c>
    SetEnvIf X-Forwarded-Proto "https" HTTPS=on
    SetEnvIf X-Forwarded-Proto "https" SERVER_PORT=443
    SetEnvIf X-Forwarded-Proto "http" SERVER_PORT=80
</IfModule>

# Security headers with ALB considerations
<IfModule mod_headers.c>
    # Only set HSTS if traffic came via HTTPS (X-Forwarded-Proto: https)
    Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" env=HTTPS
    
    # Other security headers
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Content-Security-Policy "default-src 'self'; frame-ancestors 'none'"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
    
    # Remove server signature and version info
    Header always unset Server
    Header always unset X-Powered-By
    
    # Preserve ALB headers for downstream applications if needed
    # Header always set X-Forwarded-For "%{REMOTE_ADDR}s"
</IfModule>

# ModSecurity configuration for ALB environment
<IfModule mod_security3.c>
    # Trust the X-Forwarded-For header for client IP detection
    SecAction "id:900001,phase:1,nolog,pass,ctl:requestBodyProcessor=URLENCODED"
    
    # Set real IP from X-Forwarded-For for ModSecurity rules
    SecRule REQUEST_HEADERS:X-Forwarded-For "^([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3})" \
        "id:900002,phase:1,pass,nolog,setvar:tx.real_ip=%{MATCHED_VAR}"
</IfModule>

# Ensure mod_evasive uses writable directory and considers real client IP
<IfModule mod_evasive24.c>
    DOSLogDir "/var/log/mod_evasive"
    # Note: mod_evasive will use the remoteip-processed IP thanks to mod_remoteip
</IfModule>

# Include per-site configurations
Include conf/sites-enabled/*.conf

# Container health check endpoint
<Location "/healthcheck">
    <RequireAll>
        Require all granted
    </RequireAll>
    # Simple health check response
    <IfModule mod_rewrite.c>
        RewriteEngine On
        RewriteRule .* - [R=200,L]
    </IfModule>
</Location>

# Optional: Debugging location to see headers (remove in production)
<Location "/debug-headers">
    SetHandler server-info
    Require ip 10.0.0.0/8
    Require ip 172.16.0.0/12
    Require ip 192.168.0.0/16
    <IfModule mod_info.c>
        SetHandler server-info
    </IfModule>
</Location>