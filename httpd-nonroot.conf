# httpd-nonroot.conf
# Apache configuration for running behind AWS ALB

# Set server name to suppress FQDN warning
ServerName localhost

# Listen on port 3000 for ALB traffic
Listen 3000

# Set user and group (though this won't take effect when already running as www-data)
User www-data
Group www-data

# Update PID file location to writable directory
PidFile /usr/local/apache2/run/httpd.pid

# Update log file locations with extended format for debugging
LogFormat "%h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\" \"%{X-Forwarded-For}i\" \"%{X-Forwarded-Proto}i\"" combined_with_forwarded
ErrorLog /proc/self/fd/2
CustomLog /proc/self/fd/1 combined_with_forwarded

# Load required modules for ALB integration and security
LoadModule remoteip_module modules/mod_remoteip.so
LoadModule rewrite_module modules/mod_rewrite.so
LoadModule info_module modules/mod_info.so
LoadModule logio_module modules/mod_logio.so
# LoadModule evasive_module modules/mod_evasive24.so
LoadModule security3_module modules/mod_security3.so

# ==========================================
# HIGH CONCURRENCY MPM CONFIGURATION
# ==========================================

# Use event MPM for better performance with keep-alive connections
<IfModule mpm_event_module>
    # Single process with minimal threads
    ServerLimit 2
    StartServers 1
    MinSpareThreads 5
    MaxSpareThreads 15
    ThreadsPerChild 10
    MaxRequestWorkers 20
    MaxConnectionsPerChild 10000
    ThreadLimit 25
    
    # Async request processing for better concurrency
    AsyncRequestWorkerFactor 2
</IfModule>

# Fallback to worker MPM if event is not available
<IfModule mpm_worker_module>
    ServerLimit 4
    StartServers 1
    MinSpareThreads 25
    MaxSpareThreads 75
    ThreadsPerChild 25
    MaxRequestWorkers 400
    MaxConnectionsPerChild 10000
    ThreadLimit 64
</IfModule>

# ==========================================
# CONNECTION AND TIMEOUT OPTIMIZATION
# ==========================================

# KeepAlive settings for better connection reuse
KeepAlive On
KeepAliveTimeout 5
MaxKeepAliveRequests 1000

# Timeout settings optimized for high concurrency
Timeout 30
KeepAliveTimeout 5
HostnameLookups Off

# Request processing limits
LimitRequestBody 10485760
LimitRequestFields 100
LimitRequestFieldSize 8190
LimitRequestLine 8190

# Configure mod_remoteip for AWS ALB and CloudFront
<IfModule mod_remoteip.c>
    # Trust private IP ranges (ALB)
    RemoteIPTrustedProxy 10.0.0.0/8
    RemoteIPTrustedProxy 172.16.0.0/12
    RemoteIPTrustedProxy 192.168.0.0/16     

    # Trust CloudFront IP ranges (updated from AWS IP ranges JSON, only eu-west-1&2, us-east-1, us-west-2)
    RemoteIPTrustedProxy 13.134.24.0/23
    RemoteIPTrustedProxy 13.134.94.0/23
    RemoteIPTrustedProxy 18.175.65.0/24
    RemoteIPTrustedProxy 18.175.66.0/24
    RemoteIPTrustedProxy 18.175.67.0/24
    RemoteIPTrustedProxy 18.200.212.0/23
    RemoteIPTrustedProxy 3.10.17.128/25
    RemoteIPTrustedProxy 3.11.53.0/24
    RemoteIPTrustedProxy 3.231.2.0/25
    RemoteIPTrustedProxy 3.234.232.224/27
    RemoteIPTrustedProxy 3.236.169.192/26
    RemoteIPTrustedProxy 3.236.48.0/23
    RemoteIPTrustedProxy 34.195.252.0/24
    RemoteIPTrustedProxy 34.226.14.0/24
    RemoteIPTrustedProxy 44.220.194.0/23
    RemoteIPTrustedProxy 44.220.196.0/23
    RemoteIPTrustedProxy 44.220.198.0/23
    RemoteIPTrustedProxy 44.220.200.0/23
    RemoteIPTrustedProxy 44.220.202.0/23
    RemoteIPTrustedProxy 44.222.66.0/24
    RemoteIPTrustedProxy 52.212.248.0/26
    RemoteIPTrustedProxy 52.56.127.0/25
    RemoteIPTrustedProxy 64.252.64.0/18

    # Trust CloudFront IP ranges (commented regions, all except eu-west-1&2, us-east-1, us-west-2)
    # RemoteIPTrustedProxy 108.138.0.0/15
    # RemoteIPTrustedProxy 108.156.0.0/14
    # RemoteIPTrustedProxy 111.13.171.128/26
    # RemoteIPTrustedProxy 111.13.171.192/26
    # RemoteIPTrustedProxy 111.13.185.32/27
    # RemoteIPTrustedProxy 111.13.185.64/27
    # RemoteIPTrustedProxy 116.129.226.0/25
    # RemoteIPTrustedProxy 116.129.226.128/26
    # RemoteIPTrustedProxy 118.193.97.128/25
    # RemoteIPTrustedProxy 118.193.97.64/26
    # RemoteIPTrustedProxy 119.147.182.0/25
    # RemoteIPTrustedProxy 119.147.182.128/26
    # RemoteIPTrustedProxy 120.232.236.0/25
    # RemoteIPTrustedProxy 120.232.236.128/26
    # RemoteIPTrustedProxy 120.253.240.192/26
    # RemoteIPTrustedProxy 120.253.241.160/27
    # RemoteIPTrustedProxy 120.253.245.128/26
    # RemoteIPTrustedProxy 120.253.245.192/27
    # RemoteIPTrustedProxy 120.52.12.64/26
    # RemoteIPTrustedProxy 120.52.153.192/26
    # RemoteIPTrustedProxy 120.52.22.96/27
    # RemoteIPTrustedProxy 120.52.39.128/27
    # RemoteIPTrustedProxy 13.113.196.64/26
    # RemoteIPTrustedProxy 13.113.203.0/24
    # RemoteIPTrustedProxy 13.124.199.0/24
    # RemoteIPTrustedProxy 13.203.133.0/26
    # RemoteIPTrustedProxy 13.210.67.128/26
    # RemoteIPTrustedProxy 13.224.0.0/14
    # RemoteIPTrustedProxy 13.228.69.0/24
    # RemoteIPTrustedProxy 13.233.177.192/26
    # RemoteIPTrustedProxy 13.249.0.0/16
    # RemoteIPTrustedProxy 13.32.0.0/15
    # RemoteIPTrustedProxy 13.35.0.0/16
    # RemoteIPTrustedProxy 13.54.63.128/26
    # RemoteIPTrustedProxy 13.59.250.0/26
    # RemoteIPTrustedProxy 130.176.0.0/17
    # RemoteIPTrustedProxy 130.176.128.0/18
    # RemoteIPTrustedProxy 130.176.192.0/19
    # RemoteIPTrustedProxy 130.176.224.0/20
    # RemoteIPTrustedProxy 143.204.0.0/16
    # RemoteIPTrustedProxy 144.220.0.0/16
    # RemoteIPTrustedProxy 15.158.0.0/16
    # RemoteIPTrustedProxy 15.188.184.0/24
    # RemoteIPTrustedProxy 15.207.13.128/25
    # RemoteIPTrustedProxy 15.207.213.128/25
    # RemoteIPTrustedProxy 18.154.0.0/15
    # RemoteIPTrustedProxy 18.160.0.0/15
    # RemoteIPTrustedProxy 18.164.0.0/15
    # RemoteIPTrustedProxy 18.172.0.0/15
    # RemoteIPTrustedProxy 18.192.142.0/23
    # RemoteIPTrustedProxy 18.199.68.0/22
    # RemoteIPTrustedProxy 18.199.72.0/22
    # RemoteIPTrustedProxy 18.199.76.0/22
    # RemoteIPTrustedProxy 18.216.170.128/25
    # RemoteIPTrustedProxy 18.229.220.192/26
    # RemoteIPTrustedProxy 18.230.229.0/24
    # RemoteIPTrustedProxy 18.230.230.0/25
    # RemoteIPTrustedProxy 18.238.0.0/15
    # RemoteIPTrustedProxy 18.244.0.0/15
    # RemoteIPTrustedProxy 18.64.0.0/14
    # RemoteIPTrustedProxy 18.68.0.0/16
    # RemoteIPTrustedProxy 180.163.57.0/25
    # RemoteIPTrustedProxy 180.163.57.128/26
    # RemoteIPTrustedProxy 204.246.164.0/22
    # RemoteIPTrustedProxy 204.246.168.0/22
    # RemoteIPTrustedProxy 204.246.172.0/24
    # RemoteIPTrustedProxy 204.246.173.0/24
    # RemoteIPTrustedProxy 204.246.174.0/23
    # RemoteIPTrustedProxy 204.246.176.0/20
    # RemoteIPTrustedProxy 205.251.202.0/23
    # RemoteIPTrustedProxy 205.251.204.0/23
    # RemoteIPTrustedProxy 205.251.206.0/23
    # RemoteIPTrustedProxy 205.251.208.0/20
    # RemoteIPTrustedProxy 205.251.249.0/24
    # RemoteIPTrustedProxy 205.251.250.0/23
    # RemoteIPTrustedProxy 205.251.252.0/23
    # RemoteIPTrustedProxy 205.251.254.0/24
    # RemoteIPTrustedProxy 216.137.32.0/19
    # RemoteIPTrustedProxy 23.91.0.0/19
    # RemoteIPTrustedProxy 24.110.32.0/19
    # RemoteIPTrustedProxy 3.101.158.0/23
    # RemoteIPTrustedProxy 3.107.43.128/25
    # RemoteIPTrustedProxy 3.107.44.0/25
    # RemoteIPTrustedProxy 3.107.44.128/25
    # RemoteIPTrustedProxy 3.128.93.0/24
    # RemoteIPTrustedProxy 3.134.215.0/24
    # RemoteIPTrustedProxy 3.146.232.0/22
    # RemoteIPTrustedProxy 3.147.164.0/22
    # RemoteIPTrustedProxy 3.147.244.0/22
    # RemoteIPTrustedProxy 3.160.0.0/14
    # RemoteIPTrustedProxy 3.164.0.0/18
    # RemoteIPTrustedProxy 3.164.128.0/17
    # RemoteIPTrustedProxy 3.164.64.0/18
    # RemoteIPTrustedProxy 3.165.0.0/16
    # RemoteIPTrustedProxy 3.166.0.0/15
    # RemoteIPTrustedProxy 3.168.0.0/14
    # RemoteIPTrustedProxy 3.172.0.0/18
    # RemoteIPTrustedProxy 3.172.64.0/18
    # RemoteIPTrustedProxy 3.173.0.0/17
    # RemoteIPTrustedProxy 3.173.128.0/18
    # RemoteIPTrustedProxy 3.173.192.0/18
    # RemoteIPTrustedProxy 3.174.0.0/15
    # RemoteIPTrustedProxy 3.29.40.128/26
    # RemoteIPTrustedProxy 3.29.40.192/26
    # RemoteIPTrustedProxy 3.29.40.64/26
    # RemoteIPTrustedProxy 3.29.57.0/26
    # RemoteIPTrustedProxy 3.35.130.128/25
    # RemoteIPTrustedProxy 34.216.51.0/25
    # RemoteIPTrustedProxy 34.223.12.224/27
    # RemoteIPTrustedProxy 34.223.80.192/26
    # RemoteIPTrustedProxy 35.158.136.0/24
    # RemoteIPTrustedProxy 35.162.63.192/26
    # RemoteIPTrustedProxy 35.167.191.128/26
    # RemoteIPTrustedProxy 35.93.168.0/23
    # RemoteIPTrustedProxy 35.93.170.0/23
    # RemoteIPTrustedProxy 35.93.172.0/23
    # RemoteIPTrustedProxy 36.103.232.0/25
    # RemoteIPTrustedProxy 36.103.232.128/26
    # RemoteIPTrustedProxy 43.218.56.128/26
    # RemoteIPTrustedProxy 43.218.56.192/26
    # RemoteIPTrustedProxy 43.218.56.64/26
    # RemoteIPTrustedProxy 43.218.71.0/26
    # RemoteIPTrustedProxy 44.227.178.0/24
    # RemoteIPTrustedProxy 44.234.108.128/25
    # RemoteIPTrustedProxy 44.234.90.252/30
    # RemoteIPTrustedProxy 47.129.82.0/24
    # RemoteIPTrustedProxy 47.129.83.0/24
    # RemoteIPTrustedProxy 47.129.84.0/24
    # RemoteIPTrustedProxy 51.44.234.0/23
    # RemoteIPTrustedProxy 51.44.236.0/23
    # RemoteIPTrustedProxy 51.44.238.0/23
    # RemoteIPTrustedProxy 52.124.128.0/17
    # RemoteIPTrustedProxy 52.15.127.128/26
    # RemoteIPTrustedProxy 52.199.127.192/26
    # RemoteIPTrustedProxy 52.220.191.0/26
    # RemoteIPTrustedProxy 52.222.128.0/17
    # RemoteIPTrustedProxy 52.46.0.0/18
    # RemoteIPTrustedProxy 52.47.139.0/24
    # RemoteIPTrustedProxy 52.52.191.128/26
    # RemoteIPTrustedProxy 52.57.254.0/24
    # RemoteIPTrustedProxy 52.66.194.128/26
    # RemoteIPTrustedProxy 52.78.247.128/26
    # RemoteIPTrustedProxy 52.82.128.0/19
    # RemoteIPTrustedProxy 52.84.0.0/15
    # RemoteIPTrustedProxy 54.182.0.0/16
    # RemoteIPTrustedProxy 54.192.0.0/16
    # RemoteIPTrustedProxy 54.230.0.0/17
    # RemoteIPTrustedProxy 54.230.128.0/18
    # RemoteIPTrustedProxy 54.230.200.0/21
    # RemoteIPTrustedProxy 54.230.208.0/20
    # RemoteIPTrustedProxy 54.230.224.0/19
    # RemoteIPTrustedProxy 54.233.255.128/26
    # RemoteIPTrustedProxy 54.239.128.0/18
    # RemoteIPTrustedProxy 54.239.192.0/19
    # RemoteIPTrustedProxy 54.240.128.0/18
    # RemoteIPTrustedProxy 56.125.46.0/24
    # RemoteIPTrustedProxy 56.125.47.0/32
    # RemoteIPTrustedProxy 56.125.48.0/24
    # RemoteIPTrustedProxy 57.182.253.0/24
    # RemoteIPTrustedProxy 57.183.42.0/25
    # RemoteIPTrustedProxy 58.254.138.0/25
    # RemoteIPTrustedProxy 58.254.138.128/26
    # RemoteIPTrustedProxy 64.252.128.0/18
    # RemoteIPTrustedProxy 65.8.0.0/16
    # RemoteIPTrustedProxy 65.9.0.0/17
    # RemoteIPTrustedProxy 65.9.128.0/18
    # RemoteIPTrustedProxy 70.132.0.0/18
    # RemoteIPTrustedProxy 71.152.0.0/17
    # RemoteIPTrustedProxy 99.79.169.0/24
    # RemoteIPTrustedProxy 99.84.0.0/16
    # RemoteIPTrustedProxy 99.86.0.0/16    
    
    # AWS ALB uses X-Forwarded-For for client IP
    RemoteIPHeader X-Forwarded-For
    
    # Log the original IP
    # RemoteIPTrustedProxyList /dev/null
</IfModule>

# Update document root permissions
<Directory "/usr/local/apache2/htdocs">
    Options -Indexes +FollowSymLinks
    AllowOverride None
    Require all granted
</Directory>

# Handle X-Forwarded-Proto for HTTPS detection
# This ensures ModSecurity and your application can detect HTTPS properly
<IfModule mod_setenvif.c>
    SetEnvIf X-Forwarded-Proto "https" HTTPS=on
    SetEnvIf X-Forwarded-Proto "https" SERVER_PORT=443
    SetEnvIf X-Forwarded-Proto "http" SERVER_PORT=80
</IfModule>

# Security headers with ALB considerations
<IfModule mod_headers.c>
    # Only set HSTS if traffic came via HTTPS (X-Forwarded-Proto: https)
    Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" env=HTTPS
    
    # Other security headers
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Content-Security-Policy "default-src 'self'; frame-ancestors 'none'"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
    
    # Remove server signature and version info
    Header always unset Server
    Header always unset X-Powered-By
    
    # Preserve ALB headers for downstream applications if needed
    # Header always set X-Forwarded-For "%{REMOTE_ADDR}s"
</IfModule>

# Ensure mod_evasive considers real client IP (logs disabled for Docker stdout/stderr)
<IfModule mod_evasive24.c>
    # Note: mod_evasive will use the remoteip-processed IP thanks to mod_remoteip
    # DOSLogDir is commented out to prevent file logging - events go to Apache error log instead
</IfModule>

Include conf/security.conf

# Include per-site configurations (if any exist)
IncludeOptional conf/sites-enabled/*.conf

# # Container health check endpoint
# <Location "/healthcheck">
#     <RequireAll>
#         Require all granted
#     </RequireAll>
#     # Simple health check response
#     <IfModule mod_rewrite.c>
#         RewriteEngine On
#         RewriteRule .* - [R=200,L]
#     </IfModule>
# </Location>

# # Optional: Debugging location to see headers (remove in production)
# <Location "/debug-headers">
#     SetHandler server-info
#     Require ip 10.0.0.0/8
#     Require ip 172.16.0.0/12
#     Require ip 192.168.0.0/16
#     <IfModule mod_info.c>
#         SetHandler server-info
#     </IfModule>
# </Location>
